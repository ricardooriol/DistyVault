<!DOCTYPE html>
<html>
<head>
    <title>Debug Counter Issue</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            padding: 2rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .test-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
        }
        .modal-body {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .console-log {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Debug Counter Issue</h1>
        <p>This test reproduces the exact issue from the logs.</p>
        
        <div class="modal-body" id="test-result">
            <!-- Generated by JavaScript -->
        </div>
        
        <div class="console-log" id="console-output">
            Debug information will appear here...
        </div>
    </div>
    
    <script>
        // Capture console.log for display
        const originalLog = console.log;
        const logOutput = document.getElementById('console-output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes('[NUMBERED LIST DEBUG]')) {
                const logEntry = document.createElement('div');
                logEntry.textContent = args.join(' ');
                logEntry.style.color = '#4caf50';
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };
        
        // Test the exact markdown that's causing issues
        const problemMarkdown = `1.  A secure foundation is not merely a defense mechanism but a fundamental enabler that accelerates innovation and empowers organizations to build and experiment with confidence.
2.  Identity and Access Management (IAM) is foundational to modern cloud security, requiring systems that scale to enforce the principle of least privilege at massive scales.
3.  Eliminating long-term credentials and enforcing multi-factor authentication (MFA) are critical steps to mitigate persistent security risks.
4.  Comprehensive data and network security in the cloud is achieved through pervasive encryption, advanced sovereignty controls, and integrated network protection services.`;

        // Copy the exact markdownToHtml function from the app
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            console.log(`[NUMBERED LIST DEBUG] Processing markdown: "${markdown}"`);
            
            const lines = markdown.split('\n');
            const result = [];
            let inList = false;
            let listType = null;
            let currentParagraph = [];
            let listCounter = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                console.log(`[NUMBERED LIST DEBUG] Processing line ${i}: "${trimmedLine}"`);

                // Empty line - end current paragraph or list
                if (!trimmedLine) {
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    if (inList) {
                        console.log(`[NUMBERED LIST DEBUG] Empty line - closing list type: ${listType}, final counter: ${listCounter}`);
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                        listCounter = 0;
                    }
                    continue;
                }

                // Ordered list items - GENERATE NUMBERS MANUALLY
                const orderedMatch = trimmedLine.match(/^\d+\. (.+)$/);
                if (orderedMatch) {
                    console.log(`[NUMBERED LIST DEBUG] Found ordered list item: "${trimmedLine}"`);
                    console.log(`[NUMBERED LIST DEBUG] Current state - inList: ${inList}, listType: ${listType}, listCounter: ${listCounter}`);
                    
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    
                    if (!inList || listType !== 'ol') {
                        if (inList) {
                            console.log(`[NUMBERED LIST DEBUG] Closing previous list type: ${listType}`);
                            result.push(`</${listType}>`);
                        }
                        console.log(`[NUMBERED LIST DEBUG] Starting new ordered list, resetting counter`);
                        result.push('<ol class="manual-numbered">');
                        inList = true;
                        listType = 'ol';
                        listCounter = 0;
                    } else {
                        console.log(`[NUMBERED LIST DEBUG] Continuing existing ordered list`);
                    }
                    
                    listCounter++;
                    console.log(`[NUMBERED LIST DEBUG] Counter incremented to: ${listCounter}`);
                    
                    const content = orderedMatch[1];
                    const listItem = `<li><span class="list-number">${listCounter}.</span> ${content}</li>`;
                    console.log(`[NUMBERED LIST DEBUG] Generated list item: ${listItem}`);
                    
                    result.push(listItem);
                    continue;
                }

                // Regular paragraph line
                if (inList) {
                    console.log(`[NUMBERED LIST DEBUG] Regular paragraph line found, closing list. Line: "${trimmedLine}"`);
                    result.push(`</${listType}>`);
                    inList = false;
                    listType = null;
                    listCounter = 0;
                }

                currentParagraph.push(trimmedLine);
            }

            // Flush any remaining content
            if (currentParagraph.length > 0) {
                result.push(`<p>${currentParagraph.join('<br>')}</p>`);
            }
            if (inList) {
                console.log(`[NUMBERED LIST DEBUG] End of processing - closing final list`);
                result.push(`</${listType}>`);
            }

            const finalResult = result.join('\n');
            console.log(`[NUMBERED LIST DEBUG] Final HTML result: ${finalResult}`);
            return finalResult;
        }
        
        // Run the test
        function runTest() {
            console.log('[NUMBERED LIST DEBUG] Starting debug test...');
            document.getElementById('test-result').innerHTML = markdownToHtml(problemMarkdown);
        }
        
        window.onload = runTest;
    </script>
</body>
</html>