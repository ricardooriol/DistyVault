<!DOCTYPE html>
<html>
<head>
    <title>Comprehensive Numbered List Test</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            padding: 2rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: Arial, sans-serif;
        }
        .test-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto 2rem auto;
        }
        .modal-body {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .test-section {
            margin-bottom: 3rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            border-radius: 8px;
        }
        .expected {
            color: #4caf50;
            font-weight: bold;
        }
        .console-log {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Comprehensive Numbered List Test Suite</h1>
        <p>This test verifies all aspects of the numbered list fix. Check the console (F12) for debug information.</p>
        
        <div class="test-section">
            <h2>Test 1: Static HTML Structure</h2>
            <p class="expected">Expected: Sequential numbering 1., 2., 3., 4. with black bold text</p>
            <div class="modal-body">
                <ol class="manual-numbered">
                    <li><span class="list-number">1.</span> Static first item</li>
                    <li><span class="list-number">2.</span> Static second item</li>
                    <li><span class="list-number">3.</span> Static third item</li>
                    <li><span class="list-number">4.</span> Static fourth item</li>
                </ol>
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test 2: Single JavaScript Generated List</h2>
            <p class="expected">Expected: Sequential numbering 1., 2., 3. with black bold text</p>
            <div class="modal-body" id="test2-result">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test 3: Multiple Lists (Should Reset Numbering)</h2>
            <p class="expected">Expected: First list 1., 2., 3. then second list 1., 2.</p>
            <div class="modal-body" id="test3-result">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test 4: List with Interruption</h2>
            <p class="expected">Expected: First list 1., 2. then paragraph, then new list 1., 2.</p>
            <div class="modal-body" id="test4-result">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>Test 5: Mixed Content</h2>
            <p class="expected">Expected: Header, then numbered list 1., 2., 3., then unordered list</p>
            <div class="modal-body" id="test5-result">
                <!-- Generated by JavaScript -->
            </div>
        </div>
        
        <div class="test-section">
            <h2>Console Debug Output</h2>
            <div class="console-log" id="console-output">
                Debug information will appear here...
            </div>
        </div>
    </div>
    
    <script>
        // Capture console.log for display
        const originalLog = console.log;
        const logOutput = document.getElementById('console-output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes('[NUMBERED LIST DEBUG]')) {
                const logEntry = document.createElement('div');
                logEntry.textContent = args.join(' ');
                logEntry.style.color = '#4caf50';
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };
        
        // Test markdown processing function (copied from main app)
        function markdownToHtml(markdown) {
            if (!markdown) return '';

            console.log(`[NUMBERED LIST DEBUG] Processing markdown: "${markdown}"`);
            
            const lines = markdown.split('\n');
            const result = [];
            let inList = false;
            let listType = null;
            let currentParagraph = [];
            let listCounter = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();

                // Empty line - end current paragraph or list
                if (!trimmedLine) {
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    if (inList) {
                        console.log(`[NUMBERED LIST DEBUG] Empty line - closing list type: ${listType}, final counter: ${listCounter}`);
                        result.push(`</${listType}>`);
                        inList = false;
                        listType = null;
                        listCounter = 0;
                    }
                    continue;
                }

                // Headers
                if (trimmedLine.startsWith('### ')) {
                    const state = flushParagraph(result, currentParagraph, inList, listType);
                    inList = state.inList;
                    listType = state.listType;
                    result.push(`<h3>${trimmedLine.substring(4)}</h3>`);
                    continue;
                }
                if (trimmedLine.startsWith('## ')) {
                    const state = flushParagraph(result, currentParagraph, inList, listType);
                    inList = state.inList;
                    listType = state.listType;
                    result.push(`<h2>${trimmedLine.substring(3)}</h2>`);
                    continue;
                }
                if (trimmedLine.startsWith('# ')) {
                    const state = flushParagraph(result, currentParagraph, inList, listType);
                    inList = state.inList;
                    listType = state.listType;
                    result.push(`<h1>${trimmedLine.substring(2)}</h1>`);
                    continue;
                }

                // Unordered list items
                if (trimmedLine.startsWith('- ') || trimmedLine.startsWith('* ')) {
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    if (!inList || listType !== 'ul') {
                        if (inList) result.push(`</${listType}>`);
                        result.push('<ul>');
                        inList = true;
                        listType = 'ul';
                    }
                    const content = trimmedLine.substring(2);
                    result.push(`<li>${content}</li>`);
                    continue;
                }

                // Ordered list items - GENERATE NUMBERS MANUALLY
                const orderedMatch = trimmedLine.match(/^\d+\. (.+)$/);
                if (orderedMatch) {
                    console.log(`[NUMBERED LIST DEBUG] Found ordered list item: "${trimmedLine}"`);
                    
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    
                    if (!inList || listType !== 'ol') {
                        if (inList) {
                            console.log(`[NUMBERED LIST DEBUG] Closing previous list type: ${listType}`);
                            result.push(`</${listType}>`);
                        }
                        console.log(`[NUMBERED LIST DEBUG] Starting new ordered list, resetting counter`);
                        result.push('<ol class="manual-numbered">');
                        inList = true;
                        listType = 'ol';
                        listCounter = 0;
                    }
                    
                    listCounter++;
                    console.log(`[NUMBERED LIST DEBUG] Counter incremented to: ${listCounter}`);
                    
                    const content = orderedMatch[1];
                    const listItem = `<li><span class="list-number">${listCounter}.</span> ${content}</li>`;
                    console.log(`[NUMBERED LIST DEBUG] Generated list item: ${listItem}`);
                    
                    result.push(listItem);
                    continue;
                }

                // Regular paragraph line
                if (inList) {
                    result.push(`</${listType}>`);
                    inList = false;
                    listType = null;
                    listCounter = 0;
                }

                currentParagraph.push(trimmedLine);
            }

            // Flush any remaining content
            flushParagraph(result, currentParagraph, inList, listType);

            const finalResult = result.join('\n');
            console.log(`[NUMBERED LIST DEBUG] Final HTML result: ${finalResult}`);
            return finalResult;
        }

        function flushParagraph(result, currentParagraph, inList, listType) {
            if (currentParagraph.length > 0) {
                result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                currentParagraph.length = 0;
            }
            if (inList) {
                console.log(`[NUMBERED LIST DEBUG] flushParagraph - closing list type: ${listType}`);
                result.push(`</${listType}>`);
                inList = false;
                listType = null;
            }
            return { inList: false, listType: null };
        }

        // Run tests
        function runTests() {
            console.log('[NUMBERED LIST DEBUG] Starting comprehensive test suite...');
            
            // Test 2: Single list
            const test2Markdown = `1. First generated item
2. Second generated item
3. Third generated item`;
            document.getElementById('test2-result').innerHTML = markdownToHtml(test2Markdown);
            
            // Test 3: Multiple lists
            const test3Markdown = `1. First list item one
2. First list item two
3. First list item three

Some paragraph text here.

1. Second list item one
2. Second list item two`;
            document.getElementById('test3-result').innerHTML = markdownToHtml(test3Markdown);
            
            // Test 4: List with interruption
            const test4Markdown = `1. First item
2. Second item

This is a paragraph that interrupts the list.

1. New list first item
2. New list second item`;
            document.getElementById('test4-result').innerHTML = markdownToHtml(test4Markdown);
            
            // Test 5: Mixed content
            const test5Markdown = `# Main Header

1. Numbered item one
2. Numbered item two
3. Numbered item three

- Unordered item one
- Unordered item two`;
            document.getElementById('test5-result').innerHTML = markdownToHtml(test5Markdown);
            
            console.log('[NUMBERED LIST DEBUG] All tests completed!');
        }
        
        // Run tests when page loads
        window.onload = runTests;
    </script>
</body>
</html>