<!DOCTYPE html>
<html>
<head>
    <title>Final Solution Test</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        body {
            padding: 2rem;
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        .test-container {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 12px;
            max-width: 800px;
            margin: 0 auto 2rem auto;
        }
        .modal-body {
            background: var(--bg-primary);
            padding: 2rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        .expected {
            color: #4caf50;
            font-weight: bold;
        }
        .console-log {
            background: #1a1a1a;
            padding: 1rem;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            margin-top: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Final Solution Test</h1>
        <p class="expected">Expected: Sequential numbering 1., 2., 3., 4., 5., 6., 7., 8., 9. with black bold text</p>
        
        <div class="modal-body" id="test-result">
            <!-- Generated by JavaScript -->
        </div>
        
        <div class="console-log" id="console-output">
            Debug information will appear here...
        </div>
    </div>
    
    <script>
        // Capture console.log for display
        const originalLog = console.log;
        const logOutput = document.getElementById('console-output');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && args[0].includes('[NUMBERED LIST DEBUG]')) {
                const logEntry = document.createElement('div');
                logEntry.textContent = args.join(' ');
                logEntry.style.color = '#4caf50';
                logOutput.appendChild(logEntry);
                logOutput.scrollTop = logOutput.scrollHeight;
            }
        };
        
        // Test with the exact problematic content from the logs
        const testMarkdown = `1.  A secure foundation is not merely a defense mechanism but a fundamental enabler that accelerates innovation and empowers organizations to build and experiment with confidence.
2.  Identity and Access Management (IAM) is foundational to modern cloud security, requiring systems that scale to enforce the principle of least privilege at massive scales.
3.  Eliminating long-term credentials and enforcing multi-factor authentication (MFA) are critical steps to mitigate persistent security risks.
4.  Comprehensive data and network security in the cloud is achieved through pervasive encryption, advanced sovereignty controls, and integrated network protection services.
5.  AWS actively defends customers at the network edge by leveraging internal threat intelligence and implementing custom packet processing to block malicious activity before it reaches user environments.
6.  Effective security monitoring moves beyond easily detectable alerts to actively correlate subtle signals and provide actionable insights for rapid incident response.
7.  Migrating to the cloud and modernizing technology stacks fundamentally improve an organization's security posture by leveraging a shared responsibility model and automating security operations.
8.  Generative AI is a powerful tool for transforming and accelerating security operations, from code analysis and incident response to compliance and threat detection.
9.  A strong culture of security, amplified by expert communities and strategic partnerships, is essential for navigating the evolving security landscape and enabling widespread technology adoption, including generative AI.`;

        // Copy the new robust markdownToHtml function
        function processInlineMarkdown(text) {
            if (!text) return '';
            let processed = text;
            processed = processed.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            processed = processed.replace(/\*([^*]+)\*/g, '<em>$1</em>');
            processed = processed.replace(/`([^`]+)`/g, '<code>$1</code>');
            return processed;
        }

        function markdownToHtml(markdown) {
            if (!markdown) return '';

            console.log(`[NUMBERED LIST DEBUG] Starting markdown processing...`);
            
            // ROBUST SOLUTION: Pre-process to group consecutive numbered items
            const lines = markdown.split('\n');
            const processedLines = [];
            let numberedListItems = [];
            
            // First pass: group consecutive numbered list items
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trimmedLine = line.trim();
                const orderedMatch = trimmedLine.match(/^\d+\. (.+)$/);
                
                if (orderedMatch) {
                    // This is a numbered list item
                    numberedListItems.push(orderedMatch[1]);
                    console.log(`[NUMBERED LIST DEBUG] Collected numbered item: "${orderedMatch[1]}"`);
                } else {
                    // Not a numbered list item
                    if (numberedListItems.length > 0) {
                        // We have collected numbered items, process them as a group
                        console.log(`[NUMBERED LIST DEBUG] Processing group of ${numberedListItems.length} numbered items`);
                        processedLines.push('__NUMBERED_LIST_START__');
                        numberedListItems.forEach((item, index) => {
                            processedLines.push(`__NUMBERED_ITEM_${index + 1}__${item}`);
                        });
                        processedLines.push('__NUMBERED_LIST_END__');
                        numberedListItems = [];
                    }
                    processedLines.push(line);
                }
            }
            
            // Handle any remaining numbered items at the end
            if (numberedListItems.length > 0) {
                console.log(`[NUMBERED LIST DEBUG] Processing final group of ${numberedListItems.length} numbered items`);
                processedLines.push('__NUMBERED_LIST_START__');
                numberedListItems.forEach((item, index) => {
                    processedLines.push(`__NUMBERED_ITEM_${index + 1}__${item}`);
                });
                processedLines.push('__NUMBERED_LIST_END__');
            }
            
            // Second pass: process the grouped lines
            const result = [];
            let currentParagraph = [];
            let inNumberedList = false;
            
            for (let i = 0; i < processedLines.length; i++) {
                const line = processedLines[i];
                const trimmedLine = line.trim();
                
                if (trimmedLine === '__NUMBERED_LIST_START__') {
                    // Start a numbered list
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    result.push('<ol class="manual-numbered">');
                    inNumberedList = true;
                    console.log(`[NUMBERED LIST DEBUG] Starting numbered list group`);
                    continue;
                }
                
                if (trimmedLine === '__NUMBERED_LIST_END__') {
                    // End the numbered list
                    result.push('</ol>');
                    inNumberedList = false;
                    console.log(`[NUMBERED LIST DEBUG] Ending numbered list group`);
                    continue;
                }
                
                if (trimmedLine.startsWith('__NUMBERED_ITEM_')) {
                    // Process a numbered list item
                    const match = trimmedLine.match(/^__NUMBERED_ITEM_(\d+)__(.+)$/);
                    if (match) {
                        const number = match[1];
                        const content = processInlineMarkdown(match[2]);
                        const listItem = `<li><span class="list-number">${number}.</span> ${content}</li>`;
                        result.push(listItem);
                        console.log(`[NUMBERED LIST DEBUG] Generated item ${number}: ${listItem}`);
                    }
                    continue;
                }
                
                // Handle regular content (simplified for test)
                if (!trimmedLine) {
                    if (currentParagraph.length > 0) {
                        result.push(`<p>${currentParagraph.join('<br>')}</p>`);
                        currentParagraph = [];
                    }
                    continue;
                }
                
                // Regular paragraph content
                const processedLine = processInlineMarkdown(trimmedLine);
                currentParagraph.push(processedLine);
            }
            
            // Flush any remaining paragraph
            if (currentParagraph.length > 0) {
                result.push(`<p>${currentParagraph.join('<br>')}</p>`);
            }
            
            const finalResult = result.join('\n');
            console.log(`[NUMBERED LIST DEBUG] Final result: ${finalResult}`);
            return finalResult;
        }
        
        // Run the test
        function runTest() {
            console.log('[NUMBERED LIST DEBUG] Starting final solution test...');
            document.getElementById('test-result').innerHTML = markdownToHtml(testMarkdown);
        }
        
        window.onload = runTest;
    </script>
</body>
</html>